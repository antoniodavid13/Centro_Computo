<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Tickets - TecnoSolutions</title>
    <link rel="stylesheet" th:href="@{/style.css}">
    <link rel="stylesheet" th:href="@{/tickets.css}">
</head>
<body class="dashboard-body">

<nav class="navbar">
    <div class="nav-brand">ğŸ–¥ï¸ TecnoSolutions</div>
    <div class="nav-menu">
        <a th:href="@{/monitoreo}" class="nav-link active">ğŸ“Š Monitoreo</a>
        <a th:href="@{/process-management}" class="nav-link">âš™ï¸ GestiÃ³n de Procesos</a>
        <a th:href="@{/backups}" class="nav-link">ğŸ’¾ Backups</a>
        <a th:href="@{/database}" class="nav-link active">ğŸ—„ï¸ Base de Datos</a>
        <a th:href="@{/tickets}" class="nav-link active"> ğŸ«Tickets</a>
        <a th:href="@{/logout}" class="nav-link logout">ğŸšª Cerrar SesiÃ³n</a>
    </div>
</nav>

<div class="container dashboard-content">
    <h2 class="welcome-header">ğŸ« Sistema de Tickets de Soporte</h2>

    <!-- Alertas -->
    <div id="alertsContainer"></div>

    <!-- EstadÃ­sticas - ADMIN y TECNICO -->
    <section class="monitoring-section" th:if="${userSession.isAdmin() or userSession.isTechnician()}">
        <h3>ğŸ“Š Resumen de Tickets</h3>
        <div class="stats-grid" id="statsContainer">
            <div class="stat-card stat-total">
                <div class="stat-icon">ğŸ“‹</div>
                <div class="stat-info">
                    <span class="stat-value" id="statTotal">-</span>
                    <span class="stat-label">Total</span>
                </div>
            </div>
            <div class="stat-card stat-open">
                <div class="stat-icon">ğŸ”µ</div>
                <div class="stat-info">
                    <span class="stat-value" id="statOpen">-</span>
                    <span class="stat-label">Abiertos</span>
                </div>
            </div>
            <div class="stat-card stat-progress">
                <div class="stat-icon">ğŸŸ¡</div>
                <div class="stat-info">
                    <span class="stat-value" id="statProgress">-</span>
                    <span class="stat-label">En Progreso</span>
                </div>
            </div>
            <div class="stat-card stat-critical">
                <div class="stat-icon">ğŸ”´</div>
                <div class="stat-info">
                    <span class="stat-value" id="statCritical">-</span>
                    <span class="stat-label">CrÃ­ticos</span>
                </div>
            </div>
            <div class="stat-card stat-unassigned">
                <div class="stat-icon">âš ï¸</div>
                <div class="stat-info">
                    <span class="stat-value" id="statUnassigned">-</span>
                    <span class="stat-label">Sin Asignar</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Crear Ticket - TODOS -->
    <section class="monitoring-section">
        <h3>â• Crear Nuevo Ticket</h3>
        <div class="monitoring-placeholder">
            <div class="ticket-form">
                <div class="form-row">
                    <div class="form-group form-group-large">
                        <label for="ticketTitle">TÃ­tulo del Problema *</label>
                        <input type="text"
                               id="ticketTitle"
                               class="form-input"
                               placeholder="Describa brevemente el problema">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="ticketCategory">CategorÃ­a</label>
                        <select id="ticketCategory" class="form-select">
                            <option value="HARDWARE">ğŸ–¥ï¸ Hardware</option>
                            <option value="SOFTWARE">ğŸ’¿ Software</option>
                            <option value="RED">ğŸŒ Red</option>
                            <option value="SEGURIDAD">ğŸ”’ Seguridad</option>
                            <option value="OTRO">ğŸ“ Otro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ticketPriority">Prioridad</label>
                        <select id="ticketPriority" class="form-select">
                            <option value="BAJA">ğŸŸ¢ Baja</option>
                            <option value="MEDIA" selected>ğŸŸ¡ Media</option>
                            <option value="ALTA">ğŸŸ  Alta</option>
                            <option value="CRITICA">ğŸ”´ CrÃ­tica</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="ticketDescription">DescripciÃ³n Detallada *</label>
                    <textarea id="ticketDescription"
                              class="form-textarea"
                              rows="4"
                              placeholder="Proporcione todos los detalles relevantes..."></textarea>
                </div>

                <button onclick="createTicket()" class="btn-create-ticket">
                    ğŸ« Crear Ticket
                </button>
            </div>
        </div>
    </section>

    <!-- Filtros y Lista de Tickets -->
    <section class="monitoring-section">
        <h3>ğŸ“‹ Lista de Tickets</h3>
        <div class="monitoring-placeholder">
            <!-- Filtros -->
            <div class="filters-bar">
                <div class="filter-group">
                    <label>Estado:</label>
                    <select id="filterStatus" onchange="loadTickets()">
                        <option value="">Todos</option>
                        <option value="ABIERTO">Abierto</option>
                        <option value="EN_PROGRESO">En Progreso</option>
                        <option value="PENDIENTE">Pendiente</option>
                        <option value="RESUELTO">Resuelto</option>
                        <option value="CERRADO">Cerrado</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Prioridad:</label>
                    <select id="filterPriority" onchange="loadTickets()">
                        <option value="">Todas</option>
                        <option value="CRITICA">CrÃ­tica</option>
                        <option value="ALTA">Alta</option>
                        <option value="MEDIA">Media</option>
                        <option value="BAJA">Baja</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>CategorÃ­a:</label>
                    <select id="filterCategory" onchange="loadTickets()">
                        <option value="">Todas</option>
                        <option value="HARDWARE">Hardware</option>
                        <option value="SOFTWARE">Software</option>
                        <option value="RED">Red</option>
                        <option value="SEGURIDAD">Seguridad</option>
                        <option value="OTRO">Otro</option>
                    </select>
                </div>
                <button onclick="loadTickets()" class="btn-refresh">ğŸ”„ Actualizar</button>
            </div>

            <!-- Tabla de Tickets -->
            <div class="table-container">
                <table class="tickets-table">
                    <thead>
                    <tr>
                        <th>Ticket</th>
                        <th>TÃ­tulo</th>
                        <th>CategorÃ­a</th>
                        <th>Prioridad</th>
                        <th>Estado</th>
                        <th>Creado por</th>
                        <th>Asignado a</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                    </thead>
                    <tbody id="ticketsTableBody">
                    <tr>
                        <td colspan="9" class="loading">Cargando tickets...</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</div>

<!-- Modal Ver Ticket -->
<div id="viewTicketModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>ğŸ« Detalles del Ticket</h3>
            <span class="close" onclick="closeViewModal()">&times;</span>
        </div>
        <div class="modal-body" id="ticketDetailBody">
            <div class="loading">Cargando detalles...</div>
        </div>
    </div>
</div>

<!-- Modal Asignar Ticket -->
<div id="assignModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ‘¤ Asignar Ticket</h3>
            <span class="close" onclick="closeAssignModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p>Ticket: <strong id="assignTicketNumber"></strong></p>
            <div class="form-group">
                <label for="assignTechnician">Seleccione TÃ©cnico:</label>
                <select id="assignTechnician" class="form-select">
                    <option value="">Cargando tÃ©cnicos...</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeAssignModal()" class="btn-secondary">Cancelar</button>
            <button onclick="confirmAssign()" class="btn-primary">ğŸ‘¤ Asignar</button>
        </div>
    </div>
</div>

<!-- Modal Cambiar Estado -->
<div id="statusModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ“ Cambiar Estado</h3>
            <span class="close" onclick="closeStatusModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p>Ticket: <strong id="statusTicketNumber"></strong></p>
            <div class="form-group">
                <label for="newStatus">Nuevo Estado:</label>
                <select id="newStatus" class="form-select">
                    <option value="ABIERTO">ğŸ”µ Abierto</option>
                    <option value="EN_PROGRESO">ğŸŸ¡ En Progreso</option>
                    <option value="PENDIENTE">ğŸŸ  Pendiente</option>
                    <option value="RESUELTO">ğŸŸ¢ Resuelto</option>
                    <option value="CERRADO">âš« Cerrado</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeStatusModal()" class="btn-secondary">Cancelar</button>
            <button onclick="confirmStatusChange()" class="btn-primary">âœ“ Cambiar</button>
        </div>
    </div>
</div>

<!-- Guardar informaciÃ³n del usuario -->
<script th:inline="javascript">
    const currentUserType = [[${userSession.userType}]];
    const currentUserEmail = [[${userSession.email}]];
    const currentUserName = [[${userSession.name}]];
</script>

<script th:src="@{/tickets.js}"></script>

</body>
</html>