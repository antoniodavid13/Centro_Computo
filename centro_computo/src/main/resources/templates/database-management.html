<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GestiÃ³n de Base de Datos - TecnoSolutions</title>
    <link rel="stylesheet" th:href="@{/style.css}">
    <link rel="stylesheet" th:href="@{/dashboard.css}">
    <link rel="stylesheet" th:href="@{/database.css}">
</head>
<body class="dashboard-body">

<nav class="navbar">
    <div class="nav-brand">ğŸ–¥ï¸ Centro Computo</div>
    <div class="nav-menu">
        <a th:href="@{/monitoreo}" class="nav-link active">ğŸ“Š Monitoreo</a>
        <a th:href="@{/process-management}" class="nav-link">âš™ï¸ GestiÃ³n de Procesos</a>
        <a th:href="@{/backups}" class="nav-link">ğŸ’¾ Backups</a>
        <a th:href="@{/database}" class="nav-link active">ğŸ—„ï¸ Base de Datos</a>
        <a th:href="@{/tickets}" class="nav-link active"> ğŸ«Tickets</a>
        <a th:href="@{/logout}" class="nav-link logout">ğŸšª Cerrar SesiÃ³n</a>
    </div>
</nav>

<div class="container dashboard-content">
    <h2 class="welcome-header">GestiÃ³n de Base de Datos</h2>

    <!-- Alertas -->
    <div id="alertsContainer"></div>

    <!-- EstadÃ­sticas de Rendimiento -->
    <section class="monitoring-section">
        <div class="section-header">
            <h3>ğŸ“Š EstadÃ­sticas de Rendimiento</h3>
            <div class="header-actions">
                <button onclick="loadStatistics()" class="btn-refresh">ğŸ”„ Actualizar</button>
                <span id="lastUpdate" class="last-update">Ãšltima actualizaciÃ³n: --</span>
            </div>
        </div>
        <div class="monitoring-placeholder">
            <div class="stats-grid-db">
                <div class="stat-card-db">
                    <div class="stat-icon">ğŸ”Œ</div>
                    <div class="stat-info">
                        <div class="stat-label">Conexiones Activas</div>
                        <div class="stat-value" id="activeConnections">--</div>
                        <div class="stat-detail" id="maxConnections">de --</div>
                    </div>
                </div>

                <div class="stat-card-db">
                    <div class="stat-icon">âš¡</div>
                    <div class="stat-info">
                        <div class="stat-label">Consultas/Segundo</div>
                        <div class="stat-value" id="queriesPerSecond">--</div>
                        <div class="stat-detail" id="slowQueries">-- lentas</div>
                    </div>
                </div>

                <div class="stat-card-db">
                    <div class="stat-icon">ğŸ’¾</div>
                    <div class="stat-info">
                        <div class="stat-label">TamaÃ±o de BD</div>
                        <div class="stat-value" id="databaseSize">--</div>
                        <div class="stat-detail" id="tableCount">-- tablas</div>
                    </div>
                </div>

                <div class="stat-card-db">
                    <div class="stat-icon">ğŸ“ˆ</div>
                    <div class="stat-info">
                        <div class="stat-label">Cache Hit Ratio</div>
                        <div class="stat-value" id="cacheHitRatio">--</div>
                        <div class="stat-detail">Eficiencia</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Conexiones Activas -->
    <section class="monitoring-section" th:if="${userSession.isAdmin() or userSession.isTechnician()}">
        <h3>ğŸ”Œ Conexiones Activas</h3>
        <div class="monitoring-placeholder">
            <div class="table-container">
                <table class="log-table">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Usuario</th>
                        <th>Host</th>
                        <th>Base de Datos</th>
                        <th>Comando</th>
                        <th>Tiempo (s)</th>
                        <th>Estado</th>
                    </tr>
                    </thead>
                    <tbody id="connectionsTableBody">
                    <tr>
                        <td colspan="7" class="loading">Cargando conexiones...</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Editor de Consultas SQL - SOLO ADMIN -->
    <section class="monitoring-section" th:if="${userSession.isAdmin()}">
        <h3>ğŸ’» Editor de Consultas SQL</h3>
        <div class="monitoring-placeholder">
            <div class="query-editor">
                <div class="editor-toolbar">
                    <select id="queryTimeout" class="form-select">
                        <option value="10">Timeout: 10s</option>
                        <option value="30" selected>Timeout: 30s</option>
                        <option value="60">Timeout: 60s</option>
                        <option value="120">Timeout: 120s</option>
                    </select>
                    <button onclick="executeQuery()" class="btn-execute-query">â–¶ï¸ Ejecutar</button>
                    <button onclick="clearQueryEditor()" class="btn-clear-query">ğŸ—‘ï¸ Limpiar</button>
                </div>

                <textarea id="queryEditor"
                          class="sql-editor"
                          placeholder="Escribe tu consulta SQL aquÃ­...&#10;Ejemplo: SELECT * FROM usuarios LIMIT 10;"></textarea>

                <div id="queryResults" class="query-results" style="display: none;">
                    <div class="results-header">
                        <span id="resultsTitle">Resultados</span>
                        <span id="resultsInfo" class="results-info"></span>
                    </div>
                    <div id="resultsContent" class="results-content"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Respaldo de Estructura - SOLO ADMIN -->
    <section class="monitoring-section" th:if="${userSession.isAdmin()}">
        <h3>ğŸ“¦ Respaldo de Estructura de Base de Datos</h3>
        <div class="monitoring-placeholder">
            <div class="backup-structure-form">
                <div class="form-row-horizontal">
                    <div class="form-group">
                        <label for="dbName">Nombre de la Base de Datos</label>
                        <input type="text"
                               id="dbName"
                               class="form-input"
                               placeholder="ej: centro_computo"
                               value="centro_computo">
                    </div>

                    <div class="form-group">
                        <label for="structureBackupName">Nombre del Respaldo</label>
                        <input type="text"
                               id="structureBackupName"
                               class="form-input"
                               placeholder="ej: Estructura_DB_2024">
                    </div>

                    <div class="form-group form-group-button">
                        <label>&nbsp;</label>
                        <button onclick="createStructureBackup()" class="btn-backup-structure">
                            ğŸ’¾ Crear Respaldo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<script th:src="@{/database.js}"></script>

</body>
</html>